# Handoff: 2026-02-01 Session

**Branch:** `feature/shadcn-migration`  
**Build Status:** ✅ Passing

---

## Summary of Work Done

### 1. BOQ List Table Redesign

**Changes:**
- 7-column layout optimized for readability
- Route column: Badge "N เส้นทาง" → click opens Dialog with full list
- "ก่อน VAT" column uses `total_with_factor_f` (snapshot value)
- Actions column on right with icon buttons

**New Component:** `components/boq/RouteBadge.tsx`

---

### 2. Factor F Snapshotting

**Decision:** Store factor values at save time, not calculated realtime.

**Implementation Chain:**
```
FactorFSummary.tsx (calculates)
    ↓ onFactorCalculated callback
MultiRouteEditor.tsx (passes through)
    ↓ onFactorCalculated prop
edit/page.tsx (receives & includes in boqData)
    ↓ RPC call
save_boq_with_routes (saves to DB)
```

**Database Fields Updated:**
- `factor_f` - the calculated factor value
- `total_with_factor_f` - cost × factor (before VAT)
- `total_with_vat` - cost × factor × 1.07

**RPC Migration:** Applied manually via SQL Editor (not in migration files)

---

## Lessons Learned

### ⚠️ React Hooks Rule
- **Issue:** Added `useEffect` after early return → client crash
- **Fix:** All hooks must be before any conditional returns

### ⚠️ PostgreSQL Functions
- Cannot patch functions - must `CREATE OR REPLACE` entire function
- Keep RPC definitions documented

---

## Current State

### Files Modified Today
- `components/boq/FactorFSummary.tsx` - added onFactorCalculated callback
- `components/boq/MultiRouteEditor.tsx` - passes callback through
- `components/boq/RouteBadge.tsx` - NEW component
- `app/boq/page.tsx` - uses RouteBadge, shows "ก่อน VAT" column
- `app/boq/[id]/edit/page.tsx` - includes factor fields in save

### Database Changes
- RPC `save_boq_with_routes` now saves factor_f, total_with_factor_f, total_with_vat

---

## Next Steps (Pending)

1. **Phase 2A: Database Versioning**
   - `price_list_versions` table
   - Version tracking for price lists
   - Immutable version reference on BOQ

2. **Test Factor F Display**
   - Verify old BOQs show correct values
   - BOQs without factor values may show 0 or null

3. **Consider Backfill**
   - Old BOQs don't have factor values saved
   - May need to run backfill script or handle null display

---

*Created: 2026-02-01T03:45:00+07:00*
